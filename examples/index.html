<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Client SDK Test</title>
</head>
<body>
    <script src="https://rammer.ai/lib/client.sdk.min.js"></script>
    <!--<script src="../build/client.sdk.min.js"></script>-->
    <script>
        const sdk = rammerSdk;
        const SpeakerEvent = window.SpeakerEvent;

        const getScheduleEvent = (sdk, connectionId) => {
            return (eventType, user, time) => {
                setTimeout(() => {
                    const speakerEvent = new SpeakerEvent({
                        type: eventType,
                        user
                    });
                    speakerEvent.timestamp = new Date().toISOString();

                    console.log(`Pushing event [${speakerEvent.timestamp}] ${speakerEvent.type} : ${speakerEvent.user.name}`);

                    sdk.pushEventOnConnection(connectionId, speakerEvent.toJSON(), (err) => {
                        if (err) {
                            console.error('Error during push event.', err);
                        } else {
                            console.log('Event pushed!');
                        }
                    });
                }, time * 1000);
            };
        };


        const users = {
            "john": {
                userId: 'john@example.com',
                name: 'John'
            },
            "mary": {
                userId: 'mary@example.com',
                name: 'Mary'
            },
            "tim": {
                userId: 'tim@example.com',
                name: 'Tim'
            },
            "jennifer": {
                userId: 'jennifer@example.com',
                name: 'Jennifer'
            }
        };

        sdk.init({
            appId: '6e78696d7a74406e69667a61772e7662',
            appSecret: '92a0b4f87af846f383c3c27c8070dd6a4998225ea5394b77ab8c3c117aa7169b',
            basePath: 'https://pgi-demo.rammer.ai',
            logLevel: 'trace'

        }).then(() => {
            console.log('SDK Initialized.');
            console.log('Starting the Endpoint.');
            sdk.startEndpoint({

                endpoint: {
                    // type: 'pstn',
                    // phoneNumber: '12134930857',
                    // dtmf: '0636305#'
                    providerName: 'GlobalMeet',
                    type: 'sip', // This can be pstn or sip
                    uri:  'sip:7777001044@at5-ln4-sj2-sy1.mobile.sip.pgiconnect.com;pgilink=GM;passcode=7328473933;pgijoin=silent' // Use valid SIP URI
                },
                actions: [{
                    "invokeOn": "stop",
                    "name": "sendSummaryEmail",
                    "parameters": {
                        "emails": [ // Add any email addresses to which the email should be sent
                            // "john@example.com",
                            // "mary@example.com",
                            // "jennifer@example.com",
                            // "tim@example.com"
                            "toshish@rammer.ai"
                        ]
                    }
                }],
                data: {
                    session: {
                        name: 'Client SDK Browser Test', // Title of the Meeting, this will be reflected in summary email if configured.
                        users: [
                            {
                                user: {
                                    name: "John",
                                    userId: "john@rammer.ai",
                                    role: "organizer"
                                }
                            }
                        ]
                    }
                }
            }).then(connection => {
                const connectionId = connection.connectionId;
                console.log('Successfully connected.', connectionId);

                const scheduleEvent = getScheduleEvent(sdk, connectionId);

                setTimeout(() => {

                    // This is just for interactive purposes to show the elapsed time.

                    scheduleEvent(SpeakerEvent.types.startedSpeaking, users.john, 0);
                    scheduleEvent(SpeakerEvent.types.stoppedSpeaking, users.john, 4);

                    scheduleEvent(SpeakerEvent.types.startedSpeaking, users.mary, 4);
                    scheduleEvent(SpeakerEvent.types.stoppedSpeaking, users.mary, 9);

                    // Scheduling stop endpoint call after 60 seconds
                    setTimeout(() => {
                        console.log('stopping connection ' + connection.connectionId);
                        sdk.stopEndpoint({
                            connectionId
                        }).then(() => {
                            console.log('Stopped the connection');
                        }).catch(err => console.error('Error while stopping the connection.', err));
                    }, 10000);
                }, 1000);

            }).catch(err => console.error('Error while starting the connection', err));

        }).catch(err => console.error('Error in SDK initialization.', err));
    </script>
</body>
</html>